subprojects {
  tasks.withType(Test).configureEach {
    testClassesDirs = testing.suites.test.sources.output.classesDirs
    classpath = testing.suites.test.sources.runtimeClasspath

    filter {
      includeTestsMatching "com.codeborne.selenide.*"
      includeTestsMatching "org.selenide.*"
    }
  }

  tasks.register("ie", Test) {
    systemProperties['selenide.browser'] = 'ie'
    systemProperties['selenide.timeout'] = '8000'
    filter {
      includeTestsMatching "integration.*"
      excludeTestsMatching "*.AlertText"
      excludeTestsMatching "*.ConfirmTest"
      excludeTestsMatching "com.codeborne.selenide.*"
      excludeTestsMatching "org.selenide.*"
    }
    outputs.upToDateWhen {false}
  }

  tasks.register("edge", Test) {
    systemProperties['selenide.browser'] = 'edge'
    filter {
      includeTestsMatching "integration.*"
      excludeTestsMatching "com.codeborne.selenide.*"
      excludeTestsMatching "org.selenide.*"
    }
    outputs.upToDateWhen {false}
  }

  tasks.register("edge_headless", Test) {
    systemProperties['selenide.browser'] = 'edge'
    systemProperties['selenide.headless'] = 'true'
    filter {
      includeTestsMatching "integration.*"
      excludeTestsMatching "com.codeborne.selenide.*"
      excludeTestsMatching "org.selenide.*"
    }
    outputs.upToDateWhen {false}
  }

  tasks.register("edge_headless_smoke", Test) {
    systemProperties['selenide.browser'] = 'edge'
    systemProperties['selenide.headless'] = 'true'
    filter {
      includeTestsMatching "integration.*Download*"
      excludeTestsMatching "com.codeborne.selenide.*"
      excludeTestsMatching "org.selenide.*"
    }
    outputs.upToDateWhen {false}
  }

  tasks.register("chrome", Test) {
    systemProperties['selenide.browser'] = 'chrome'
    filter {
      includeTestsMatching "integration.*"
      excludeTestsMatching "com.codeborne.selenide.*"
      excludeTestsMatching "org.selenide.*"
    }
    outputs.upToDateWhen {false}
  }

  tasks.register("chrome_headless", Test) {
    systemProperties['selenide.browser'] = 'chrome'
    systemProperties['selenide.headless'] = 'true'
    filter {
      includeTestsMatching "integration.*"
      excludeTestsMatching "com.codeborne.selenide.*"
      excludeTestsMatching "org.selenide.*"
    }
    outputs.upToDateWhen {false}
  }

  tasks.register("chrome_headless_smoke", Test) {
    systemProperties['selenide.browser'] = 'chrome'
    systemProperties['selenide.headless'] = 'true'
    filter {
      includeTestsMatching "integration.*Download*"
      excludeTestsMatching "com.codeborne.selenide.*"
      excludeTestsMatching "org.selenide.*"
    }
    outputs.upToDateWhen {false}
  }

  tasks.register("chrome_remote", Test) {
    systemProperties['selenide.remote'] = 'http://localhost:4444/wd/hub'
    systemProperties['selenide.browser'] = 'chrome'
    filter {
      includeTestsMatching "integration.*"
      excludeTestsMatching "com.codeborne.selenide.*"
      excludeTestsMatching "org.selenide.*"
    }
    outputs.upToDateWhen {false}
  }

  tasks.register("firefox", Test) {
    systemProperties['selenide.browser'] = 'firefox'
    filter {
      includeTestsMatching "integration.*"
      excludeTestsMatching "com.codeborne.selenide.*"
      excludeTestsMatching "org.selenide.*"
    }
    outputs.upToDateWhen {false}
  }

  tasks.register("firefox_headless", Test) {
    systemProperties['selenide.browser'] = 'firefox'
    systemProperties['selenide.headless'] = 'true'
    filter {
      includeTestsMatching "integration.*"
      excludeTestsMatching "com.codeborne.selenide.*"
      excludeTestsMatching "org.selenide.*"
    }
    outputs.upToDateWhen {false}
  }

  tasks.register("safari", Test) {
    systemProperties['selenide.browser'] = 'safari'
    filter {
      includeTestsMatching "integration.*"
      excludeTestsMatching "com.codeborne.selenide.*"
      excludeTestsMatching "org.selenide.*"
    }
    maxParallelForks = 1
    outputs.upToDateWhen {false}
  }

  tasks.register("firefox_remote", Test) {
    systemProperties['selenide.remote'] = 'http://localhost:4444/wd/hub'
    systemProperties['selenide.browser'] = 'firefox'
    filter {
      includeTestsMatching "integration.*"
      excludeTestsMatching "com.codeborne.selenide.*"
      excludeTestsMatching "org.selenide.*"
    }
    outputs.upToDateWhen {false}
  }

  tasks.withType(Test).configureEach {
    useJUnitPlatform()
    systemProperties['selenide.reportsFolder'] = layout.buildDirectory.dir("reports/tests/${name}").get().asFile
    systemProperties['selenide.downloadsFolder'] = layout.buildDirectory.dir("tests/downloads").get().asFile

    System.properties.stringPropertyNames()
      .findAll { it.startsWith("selenide.") }
      .forEach {
        println " set ${it} to ${System.getProperty(it)}"
        systemProperties[it] = System.getProperty(it)
      }

    jvmArgs = ['-ea', '-Xmx512m']
    systemProperties['file.encoding'] = encoding
    systemProperties['user.country'] = 'TR'
    systemProperties['user.language'] = 'tr'

    testLogging {
      events "passed", "skipped", "failed"
      showExceptions = true
      exceptionFormat = 'full'
    }
  }

  tasks.register("allTests") {
    dependsOn tasks.named('clean'), tasks.named('check'), tasks.named('firefox_headless'), tasks.named('chrome_headless')
  }
}

